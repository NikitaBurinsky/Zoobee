# Модели данных и БД

База данных выступает и хранилищем истории, и очередью задач.

## 1. Таблица `ScrapingTasks` (Задачи)

Единица работы парсера. Один URL = Одна запись.

| Поле | Тип | Описание |
| :--- | :--- | :--- |
| `Id` | GUID | Уникальный идентификатор. |
| `Url` | string | **Unique Index**. Ссылка на страницу. |
| `SourceName` | string | Источник (например, "Wildberries"). |
| `Type` | Enum | Тип страницы (см. ниже). Важно для логики трансформации. |
| `Status` | Enum | Текущее состояние (Pending, Success, Failed). |
| `NextTryAt` | DateTime | **Index**. Время следующего скачивания. Воркер выбирает задачи, где `NextTryAt <= Now`. |
| `AttemptCount`| int | Количество неудачных попыток подряд. |

### ScrapingTaskType (Enum)
* `0 - Unknown`: Тип не определен.
* `1 - ProductPage`: Страница конкретного товара.
* `2 - ListingPage`: Категория или список товаров (нужно искать ссылки на продукты).
* `3 - Sitemap`: XML или HTML карта сайта (нужно искать ссылки на вложенные карты или продукты).

## 2. Таблица `ScrapingData` (История)

Снапшоты скачанного контента. Отношение к Tasks: **Many-to-One**.

| Поле | Тип | Описание |
| :--- | :--- | :--- |
| `Id` | GUID | Уникальный идентификатор. |
| `ScrapingTaskId`| GUID | Ссылка на родительскую задачу. |
| `Content` | string | "Сырой" HTML или XML. Может быть NULL, если была сетевая ошибка. |
| `HttpStatusCode`| int | Код ответа сервера (200, 404, 500). |
| `CreatedAt` | DateTime | Дата и время фактического скачивания. |

## Принципы работы с данными

1.  **Идемпотентность**: Повторный запуск Seeder'а не создает дублей задач.
2.  **Soft Updates**: Мы стараемся не удалять задачи, даже если товар исчез (404), чтобы сохранить историю цен и наличия.
3.  **Lazy Loading**: При выборке задач для парсинга мы используем `AsNoTracking()` для скорости.